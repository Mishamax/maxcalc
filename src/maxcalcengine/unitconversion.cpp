
// Local
#include "unitconversion.h"
#include "exceptions.h"

namespace MaxCalcEngine {

// All constants have 150 digits precision
UnitConversion::SimpleConversion UnitConversion::simpleConversions_[] =
{
	//---------------------------------------------------------------------
	// Length
	// Mil
	MIL,	IN,		"0.001",
	MIL,	FT,		"0.0000833333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333",
	MIL,	YD,		"0.0000277777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777778",
	MIL,	MI,		"1.5782828282828282828282828282828282828282828282828282828282828282828282828282828282828282828282828282828282828282828282828282828282828282828282828282828283e-8",
	MIL,	MICRON,	"25.4",
	MIL,	MM,		"0.0254",
	MIL,	CM,		"0.00254",
	MIL,	M,		"0.0000254",
	MIL,	KM,		"0.0000000254",
	// Inch
	IN,		MIL,	"1000",
	IN,		FT,		"0.0833333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333",
	IN,		YD,		"0.0277777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777778",
	IN,		MI,		"1.5782828282828282828282828282828282828282828282828282828282828282828282828282828282828282828282828282828282828282828282828282828282828282828282828282828283e-5",
	IN,		MICRON,	"25400",
	IN,		MM,		"25.4",
	IN,		CM,		"2.54",
	IN,		M,		"0.0254",
	IN,		KM,		"0.0000254",
	// Foot
	FT,		MIL,	"12000",
	FT,		IN,		"12",
	FT,		YD,		"0.3333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333",
	FT,		MI,		"1.8939393939393939393939393939393939393939393939393939393939393939393939393939393939393939393939393939393939393939393939393939393939393939393939393939393939e-4",
	FT,		MICRON,	"304800",
	FT,		MM,		"304.8",
	FT,		CM,		"30.48",
	FT,		M,		"0.3048",
	FT,		KM,		"0.0003048",
	// Yard
	YD,		MIL,	"36000",
	YD,		IN,		"36",
	YD,		FT,		"3",
	YD,		MI,		"5.6818181818181818181818181818181818181818181818181818181818181818181818181818181818181818181818181818181818181818181818181818181818181818181818181818181818e-4",
	YD,		MICRON,	"914400",
	YD,		MM,		"914.4",
	YD,		CM,		"91.44",
	YD,		M,		"0.9144",
	YD,		KM,		"0.0009144",
	// Mile
	MI,		MIL,	"63360000",
	MI,		IN,		"63360",
	MI,		FT,		"5280",
	MI,		YD,		"1760",
	MI,		MICRON,	"1609344000",
	MI,		MM,		"1609344",
	MI,		CM,		"160934.4",
	MI,		M,		"1609.344",
	MI,		KM,		"1.609344",
	// Micrometer
	MICRON,	MIL,	"0.03937007874015748031",
	MICRON,	IN,		"0.00003937007874015748031",
	MICRON,	FT,		"0.00000328083989501312336",
	MICRON,	YD,		"0.00000109361329833770779",
	MICRON,	MI,		"6.21371192237333969617e-10",
	MICRON,	MM,		"0.001",
	MICRON,	CM,		"0.0001",
	MICRON,	M,		"0.000001",
	MICRON,	KM,		"0.000000001",
	// Millimeter
	MM,		MIL,	"39370.078740157480314960629921259842519685039370078740157480314960629921259842519685039370078740157480314960629921259842519685039370078740157480314960629921e-3",
	MM,		IN,		"39.370078740157480314960629921259842519685039370078740157480314960629921259842519685039370078740157480314960629921259842519685039370078740157480314960629921e-3",
	MM,		FT,		"3.2808398950131233595800524934383202099737532808398950131233595800524934383202099737532808398950131233595800524934383202099737532808398950131233595800524934e-3",
	MM,		YD,		"1.0936132983377077865266841644794400699912510936132983377077865266841644794400699912510936132983377077865266841644794400699912510936132983377077865266841645e-3",
	MM,		MI,		"6.2137119223733396961743418436331822158593812137119223733396961743418436331822158593812137119223733396961743418436331822158593812137119223733396961743418436e-7",
	MM,		MICRON,	"1000",
	MM,		CM,		"0.1",
	MM,		M,		"0.001",
	MM,		KM,		"0.000001",
	// Cantimeter
	CM,		MIL,	"39370.078740157480314960629921259842519685039370078740157480314960629921259842519685039370078740157480314960629921259842519685039370078740157480314960629921e-2",
	CM,		IN,		"39.370078740157480314960629921259842519685039370078740157480314960629921259842519685039370078740157480314960629921259842519685039370078740157480314960629921e-2",
	CM,		FT,		"3.2808398950131233595800524934383202099737532808398950131233595800524934383202099737532808398950131233595800524934383202099737532808398950131233595800524934e-2",
	CM,		YD,		"1.0936132983377077865266841644794400699912510936132983377077865266841644794400699912510936132983377077865266841644794400699912510936132983377077865266841645e-2",
	CM,		MI,		"6.2137119223733396961743418436331822158593812137119223733396961743418436331822158593812137119223733396961743418436331822158593812137119223733396961743418436e-6",
	CM,		MICRON,	"10000",
	CM,		MM,		"10",
	CM,		M,		"0.01",
	CM,		KM,		"0.00001",
	// Meter
	M,		MIL,	"39370.078740157480314960629921259842519685039370078740157480314960629921259842519685039370078740157480314960629921259842519685039370078740157480314960629921",
	M,		IN,		"39.370078740157480314960629921259842519685039370078740157480314960629921259842519685039370078740157480314960629921259842519685039370078740157480314960629921",
	M,		FT,		"3.2808398950131233595800524934383202099737532808398950131233595800524934383202099737532808398950131233595800524934383202099737532808398950131233595800524934",
	M,		YD,		"1.0936132983377077865266841644794400699912510936132983377077865266841644794400699912510936132983377077865266841644794400699912510936132983377077865266841645",
	M,		MI,		"6.2137119223733396961743418436331822158593812137119223733396961743418436331822158593812137119223733396961743418436331822158593812137119223733396961743418436e-4",
	M,		MICRON,	"1000000",
	M,		MM,		"1000",
	M,		CM,		"100",
	M,		KM,		"0.001",
	// Kilometer
	KM,		MIL,	"39370.078740157480314960629921259842519685039370078740157480314960629921259842519685039370078740157480314960629921259842519685039370078740157480314960629921e+3",
	KM,		IN,		"39.370078740157480314960629921259842519685039370078740157480314960629921259842519685039370078740157480314960629921259842519685039370078740157480314960629921e+3",
	KM,		FT,		"3.2808398950131233595800524934383202099737532808398950131233595800524934383202099737532808398950131233595800524934383202099737532808398950131233595800524934e+3",
	KM,		YD,		"1.0936132983377077865266841644794400699912510936132983377077865266841644794400699912510936132983377077865266841644794400699912510936132983377077865266841645e+3",
	KM,		MI,		"0.6213711922373339696174341843633182215859381213711922373339696174341843633182215859381213711922373339696174341843633182215859381213711922373339696174341844",
	KM,		MICRON,	"1000000000",
	KM,		MM,		"1000000",
	KM,		CM,		"100000",
	KM,		M,		"1000",
	//---------------------------------------------------------------------
	// Weight
	// Pound
	LB,		OZ,		"16.000002821917267029565227206668754885444268544934799601545281895425389918418371810175269281455206296261806196365934943519325900403251977458524870967832965",
	LB,		G,		"453.5924",
	LB,		KG,		"0.4535924",
	// Ounce
	OZ,		LB,		"0.0624999889768876198102084602828442451857658990759104429439293956424313987624131268513317242528754890954963090210506172502008411075670580018536465778527153",
	OZ,		G,		"28.34952",
	OZ,		KG,		"0.02834952",
	// Gramme
	G,		LB,		"0.0022046224760379583079434311509628468201848179114112141208715137202475173746297336551494249021809007381957898765499598317784865883996292706844294569309362",
	G,		OZ,		"0.0352739658378695653400833594360680533568116849950193160236928173739802296476271908660181900787032725774545741867939915737550406497182315608870979120634141",
	G,		KG,		"0.001",
	// Kilogramme
	KG,		LB,		"2.2046224760379583079434311509628468201848179114112141208715137202475173746297336551494249021809007381957898765499598317784865883996292706844294569309362326",
	KG,		OZ,		"35.273965837869565340083359436068053356811684995019316023692817373980229647627190866018190078703272577454574186793991573755040649718231560887097912063414125",
	KG,		G,		"1000",
	//---------------------------------------------------------------------
	// Time
	// Microsecond
	MICROS,	MS,		"0.001",
	MICROS,	S,		"0.000001",
	MICROS,	MIN,	"0.0000000166666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666667",
	MICROS,	H,		"2.7777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777778e-10",
	MICROS,	D,		"1.1574074074074074074074074074074074074074074074074074074074074074074074074074074074074074074074074074074074074074074074074074074074074074074074074074074074e-11",
	// Millisecond
	MS,		MICROS,	"1000",
	MS,		S,		"0.001",
	MS,		MIN,	"0.0000166666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666667",
	MS,		H,		"2.7777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777778e-7",
	MS,		D,		"1.1574074074074074074074074074074074074074074074074074074074074074074074074074074074074074074074074074074074074074074074074074074074074074074074074074074074e-8",
	// Second
	S,		MICROS,	"1000000",
	S,		MS,		"1000",
	S,		MIN,	"0.0166666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666667",
	S,		H,		"2.7777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777778e-4",
	S,		D,		"1.1574074074074074074074074074074074074074074074074074074074074074074074074074074074074074074074074074074074074074074074074074074074074074074074074074074074e-5",
	// Minute
	MIN,	MICROS,	"60000000",
	MIN,	MS,		"60000",
	MIN,	S,		"60",
	MIN,	H,		"0.0166666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666667",
	MIN,	D,		"6.9444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444e-4",
	// Hour
	H,		MICROS,	"3600000000",
	H,		MS,		"3600000",
	H,		S,		"3600",
	H,		MIN,	"60",
	H,		D,		"0.0416666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666667",
	// Day
	D,		MICROS,	"86400000000",
	D,		MS,		"86400000",
	D,		S,		"86400",
	D,		MIN,	"1440",
	D,		H,		"24",
	//---------------------------------------------------------------------
	// Speed
	// mi/hour
	MIpH,	MpS,	"0.44704",
	MIpH,	FTpH,	"1760",
	MIpH,	KMpH,	"1.609344",
	MIpH,	KNOT,	"0.8689762419006479481641468682505399568034557235421166306695464362850971922246220302375809935205183585313174946004319654427645788336933045356371490280777538",
	// Meter/second
	MpS,	MIpH,	"2.2369362920544022906227630637079455977093772369362920544022906227630637079455977093772369362920544022906227630637079455977093772369362920544022906227630637",
	MpS,	FTpH,	"3937.0078740157480314960629921259842519685039370078740157480314960629921259842519685039370078740157480314960629921259842519685039370078740157480314960629921",
	MpS,	KMpH,	"3.6",
	MpS,	KNOT,	"1.9438444924406047516198704103671706263498920086393088552915766738660907127429805615550755939524838012958963282937365010799136069114470842332613390928725702",
	// Foot/hour
	FTpH,	MIpH,	"5.6818181818181818181818181818181818181818181818181818181818181818181818181818181818181818181818181818181818181818181818181818181818181818181818181818181818e-4",
	FTpH,	MpS,	"0.000254",
	FTpH,	KMpH,	"0.0009144",
	FTpH,	KNOT,	"4.9373650107991360691144708423326133909287257019438444924406047516198704103671706263498920086393088552915766738660907127429805615550755939524838012958963283e-4",
	// Kilometre/hour
	KMpH,	MIpH,	"0.6213711922373339696174341843633182215859381213711922373339696174341843633182215859381213711922373339696174341843633182215859381213711922373339696174341844",
	KMpH,	MpS,	"0.2777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777778",
	KMpH,	FTpH,	"1093.6132983377077865266841644794400699912510936132983377077865266841644794400699912510936132983377077865266841644794400699912510936132983377077865266841645",
	KMpH,	KNOT,	"0.5399568034557235421166306695464362850971922246220302375809935205183585313174946004319654427645788336933045356371490280777537796976241900647948164146868251",
	// Knot
	KNOT,	MIpH,	"1.1507794480235425117314881094408653463771574007794480235425117314881094408653463771574007794480235425117314881094408653463771574007794480235425117314881094",
	KNOT,	MpS,	"0.5144444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444",
	KNOT,	FTpH,	"2025.3718285214348206474190726159230096237970253718285214348206474190726159230096237970253718285214348206474190726159230096237970253718285214348206474190726",
	KNOT,	KMpH,	"1.852",
	END,	END,	0
};

UnitConversion::ArbitraryConversion UnitConversion::arbitraryConversions_[] =
{
	C,		F,		UnitConversion::ctof,
	C,		K,		UnitConversion::ctok,
	F,		C,		UnitConversion::ftoc,
	F,		K,		UnitConversion::ftok,
	K,		C,		UnitConversion::ktoc,
	K,		F,		UnitConversion::ktof,
	END,	END,	0
};

std::map<tstring, UnitConversion::Unit> UnitConversion::units_;

BigDecimal UnitConversion::convert(const BigDecimal arg, const tstring & unit1, const tstring & unit2)
{
	static bool firstRun = true;
	if (firstRun)
	{
		initUnits();
		firstRun = false;
	}

	Unit u1 = units_[unit1];
	Unit u2 = units_[unit2];

	if (u1 == END || u2 == END)
		throw UnknownUnitConversionException();

	// Look up simple conversions table
	for (SimpleConversion * cur = simpleConversions_; cur->unit1 != END; cur++)
	{
		if (u1 == cur->unit1 && u2 == cur->unit2)
			return arg * cur->multiplier;
	}

	// Look up arbitrary conversions table
	for (ArbitraryConversion * cur = arbitraryConversions_; cur->unit1 != END; cur++)
	{
		if (u1 == cur->unit1 && u2 == cur->unit2)
			return cur->convert(arg);
	}

	throw UnknownUnitConversionException();
}

void UnitConversion::initUnits()
{
	// Length
	units_[_T("mil")] = MIL;
	units_[_T("in")] = IN;
	units_[_T("ft")] = FT;
	units_[_T("yd")] = YD;
	units_[_T("mi")] = MI;
	units_[_T("micron")] = MICRON;
	units_[_T("mm")] = MM;
	units_[_T("cm")] = CM;
	units_[_T("m")] = M;
	units_[_T("km")] = KM;

	// Weight
	units_[_T("lb")] = LB;
	units_[_T("oz")] = OZ;
	units_[_T("g")] = G;
	units_[_T("kg")] = KG;

	// Time
	units_[_T("micros")] = MICROS;
	units_[_T("ms")] = MS;
	units_[_T("s")] = S;
	units_[_T("min")] = MIN;
	units_[_T("h")] = H;
	units_[_T("d")] = D;

	// Speed
	units_[_T("mi/h")] = MIpH;
	units_[_T("m/s")] = MpS;
	units_[_T("ft/h")] = FTpH;
	units_[_T("km/h")] = KMpH;
	units_[_T("knot")] = KNOT;

	// Temperature
	units_[_T("k")] = K;
	units_[_T("c")] = C;
	units_[_T("f")] = F;
}

} // namespace MaxCalcEngine
